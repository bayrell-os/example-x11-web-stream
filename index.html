<html>
<head>
<title>Video stream</title>
</head>
<body>

<video id="videoPlayer" controls="false" autoplay></video>
<canvas id="videoCanvas" style="display: none;"></canvas>

<button id="playButton">Play</button>

<script>

document.getElementById('playButton').addEventListener("click", () => {
	
	let canvas = document.getElementById('videoCanvas');
	canvas.width = 1024 * 500 / 768;
	canvas.height = 500;
	
	let context = canvas.getContext('2d');
	
	let socket = null;
	let player = document.getElementById('videoPlayer');
	let media_source = new MediaSource();
	player.src = URL.createObjectURL(media_source);
	
	let media_source_buffer = null;
	let media_queue = [];
	let media_updating = false;
	
	const processQueue = () => {
		if (media_queue.length == 0) return;
		if (media_source_buffer == null) return;
		if (media_source_buffer.updating) return;
		let data = media_queue.shift();
		console.log(data['byteLength']);
		media_source_buffer.appendBuffer(data);
	};
	
	media_source.addEventListener('sourceopen', function() {
		
		let codec = 'video/mp4; codecs="avc1.42E01E"';
		//let codec = 'video/webm; codecs="vp8"';
		//let codec = 'video/mp4; codecs="mp4a.40.2, avc1.4d401f"';
		//let codec = 'video/mp4; codecs="avc1.4D0029"';
		
		media_source_buffer = media_source.addSourceBuffer(codec);
		media_source_buffer.mode = 'sequence';
		
		media_source_buffer.addEventListener('update', function() {
			processQueue();
		});
		
		media_source_buffer.addEventListener('updateend', function() {
			processQueue();
		});
		
	});
	
	const videoDraw = (data) => {
		
		if (media_source_buffer == null) return;
		
		media_queue.push(data);
		processQueue();
		
	};
	
	socket = new WebSocket("ws://127.0.0.1:8080/");
	socket.binaryType = 'arraybuffer';
	
	socket.onopen = function(e) {
		console.log("socket connected");
	};
	
	socket.onmessage = function(event) {
	};
	
	socket.onclose = function(event) {
		console.log("socket disconnected");
	};
	
	socket.onerror = function(error) {
		console.log(error);
	};
	
	const jpegDraw = (data) => {
		var imageObj = new Image();
		imageObj.src = "data:image/jpeg;base64,"+data;
		imageObj.onload = () => {
			context.height = imageObj.height;
			context.width = imageObj.width;
			context.drawImage(imageObj,0,0,context.width,context.height);
		}
	};
	
	socket.onmessage = function(event) {
		
		try {
			videoDraw(event.data);
		}
		catch(e){
			console.log(e);
		}
		
	};

});

</script>

</body>
</html>
