<html>
<head>
<title>Video stream</title>
</head>
<body>

<video id="videoPlayer" controls="false" autoplay></video>
<canvas id="videoCanvas" style="display: none;"></canvas>

<button id="playButton">Play</button>

<script>

document.getElementById('playButton').addEventListener("click", () => {
	
	//let w = 1440 * 500 / 900;
	//let h = 500;
	let w = 1440;
	h = 900;
	
	let canvas = document.getElementById('videoCanvas');
	canvas.width = w;
	canvas.height = h;
	
	let context = canvas.getContext('2d');
	
	let socket = null;
	let player = document.getElementById('videoPlayer');
	player.width = w;
	player.height = h;
	
	let media_source = new MediaSource();
	player.src = URL.createObjectURL(media_source);
	player.play();
	
	//console.log("Status: " + media_source.readyState);
	
	const getDateString = () => {
		let date = new Date();
		return date.toLocaleDateString() + " " + date.toLocaleTimeString();
	};
	
	const mediaSourceLog = (event) => () => {
		console.log("[" + getDateString() + "] " + event + ": " + media_source.readyState);
	};
	
	let media_source_buffer = null;
	let media_queue = [];
	let is_error = false;
	
	const processQueue = () => {
		if (media_queue.length == 0) return;
		if (media_source.readyState != 'open') return;
		if (media_source_buffer == null) return;
		if (media_source_buffer.updating) return;
		let data = media_queue.shift();
		console.log("[" + getDateString() + "] processQueue: " + data['byteLength']);
		media_source_buffer.appendBuffer(data);
	};
	
	const addVideoSegment = (data) => {
		if (is_error) return;
		console.log("[" + getDateString() + "] onmessage: " + event.data['byteLength']);
		//if (media_source.readyState != 'open') return;
		
		media_queue.push(data);
		processQueue();
	};
	
	media_source.addEventListener('sourceopen', mediaSourceLog('source_open'));
	media_source.addEventListener('sourceended', mediaSourceLog('source_ended'));
	media_source.addEventListener('sourceclose', mediaSourceLog('source_close'));
	media_source.addEventListener('error', mediaSourceLog('source_error'));
	media_source.addEventListener('error', (e) => { console.log(e); is_error = true; });
	
	media_source.addEventListener('sourceopen', function() {
		
		if (media_source_buffer != null) return;
		
		//let codec = 'video/webm; codecs="vp8"';
		//let codec = 'video/mp4; codecs="mp4a.40.2, avc1.4d401f"';
		//let codec = 'video/mp4; codecs="avc1.4D0029"';
		//let codec = 'video/mp4; codecs="avc1.42E01E"';
		
		let codec = 'video/mp4; codecs="avc1.42E01E"';
		media_source_buffer = media_source.addSourceBuffer(codec);
		media_source_buffer.mode = 'sequence';
		
		//media_source_buffer.addEventListener('updatestart', mediaSourceLog('buffer_updatestart'));
		//media_source_buffer.addEventListener('update', mediaSourceLog('buffer_update'));
		media_source_buffer.addEventListener('updateend', mediaSourceLog('buffer_updateend'));
		
		media_source_buffer.addEventListener('abort', mediaSourceLog('buffer_abort'));
		media_source_buffer.addEventListener('error', mediaSourceLog('buffer_error'));
		media_source_buffer.addEventListener('error', (e) => { console.log(e); is_error = true; });
		
		media_source_buffer.addEventListener('update', function() {
			//processQueue();
		});
		
		media_source_buffer.addEventListener('updateend', function() {
			
			console.log("Duration: " + media_source.duration);
			console.log("currentTime: " + player.currentTime);
			
			processQueue();
			
			/*
			if (
				media_source.duration !== Number.POSITIVE_INFINITY &&
				player.currentTime === 0 &&
				media_source.duration > 0
			)
			{
                player.currentTime = media_source.duration - 1;
                media_source.duration = Number.POSITIVE_INFINITY;
            }
            */
		});
		
	});
	
	socket = new WebSocket("ws://127.0.0.1:8080/");
	socket.binaryType = 'arraybuffer';
	
	socket.onopen = function(e) {
		console.log("socket connected");
	};
	
	socket.onmessage = function(event) {
	};
	
	socket.onclose = function(event) {
		console.log("socket disconnected");
	};
	
	socket.onerror = function(error) {
		console.log(error);
	};
	
	const jpegDraw = (data) => {
		var imageObj = new Image();
		imageObj.src = "data:image/jpeg;base64,"+data;
		imageObj.onload = () => {
			context.height = imageObj.height;
			context.width = imageObj.width;
			context.drawImage(imageObj,0,0,context.width,context.height);
		}
	};
	
	socket.onmessage = function(event) {
		addVideoSegment(event.data);
	};

});

</script>

</body>
</html>
